<?php require_once '../../config/config.php'; require_once '../../session.php'; $d=json_decode(file_get_contents('php://input'),true); $name=trim($d['name']??''); $email=strtolower(trim($d['email']??'')); $password=$d['password']??''; $phone=trim($d['phone']??''); $referral=trim($d['referral_code']??''); $invite=trim($d['invite_code']??''); if(!$name||!$email||!$password){http_response_code(400);echo json_encode(['error'=>'Missing required']);exit;} if(!filter_var($email,FILTER_VALIDATE_EMAIL)){http_response_code(400);echo json_encode(['error'=>'Invalid email']);exit;} try{$st=$pdo->prepare('SELECT id FROM users WHERE email=?');$st->execute([$email]); if($st->fetch()){http_response_code(409);echo json_encode(['error'=>'Email exists']);exit;} $hash=password_hash($password,PASSWORD_DEFAULT); $referred_by=NULL; if($referral){$st=$pdo->prepare('SELECT referral_code FROM users WHERE referral_code=?');$st->execute([$referral]); if($st->fetch())$referred_by=$referral;} $code=substr(str_shuffle('ABCDEFGHJKLMNPQRSTUVWXYZ23456789'),0,8); $st=$pdo->prepare('INSERT INTO users(name,email,password,phone,referral_code,referred_by) VALUES(?,?,?,?,?,?)');$st->execute([$name,$email,$hash,$phone,$code,$referred_by]); $uid=$pdo->lastInsertId(); $welcome=0; if(strtolower($invite)!=='demo'){ $welcome=15.00; $pdo->prepare('UPDATE users SET balance=balance+? WHERE id=?')->execute([$welcome,$uid]); $pdo->prepare("INSERT INTO user_balance_transactions(user_id,amount,type,description) VALUES(?,?,'welcome_bonus','Welcome bonus')")->execute([$uid,$welcome]); } $_SESSION['user_id']=$uid; echo json_encode(['success'=>true,'user_id'=>$uid,'welcome_bonus'=>$welcome]); }catch(Exception $e){http_response_code(500);echo json_encode(['error'=>'Server error','detail'=>$e->getMessage()]);} ?>