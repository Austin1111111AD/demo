<?php require_once '../../config/config.php'; require_once '../../session.php'; $uid=require_user(); $st=$pdo->prepare('SELECT vip_level FROM users WHERE id=?');$st->execute([$uid]); $vip=intval(($st->fetch()['vip_level']??1)); $st=$pdo->prepare('SELECT * FROM products WHERE is_active=1 AND vip_required<=?');$st->execute([$vip]); $products=$st->fetchAll(); if(!$products){http_response_code(404);echo json_encode(['error'=>'No products available']);exit;} $random=$products[array_rand($products)]; $pdo->prepare('INSERT INTO user_lottery_tasks(user_id,product_id) VALUES(?,?)')->execute([$uid,$random['id']]); $task_id=$pdo->lastInsertId(); echo json_encode(['success'=>true,'task_id'=>$task_id,'product'=>$random]); ?>