<?php require_once '../../config/config.php'; require_once '../../session.php'; $uid=require_user(); $d=json_decode(file_get_contents('php://input'),true); $tid=intval($d['task_id']??0); if(!$tid){http_response_code(400);echo json_encode(['error'=>'task_id required']);exit;} $st=$pdo->prepare('SELECT ult.*,p.id pid FROM user_lottery_tasks ult JOIN products p ON p.id=ult.product_id WHERE ult.id=? AND ult.user_id=? AND ult.status="pending"');$st->execute([$tid,$uid]); $task=$st->fetch(); if(!$task){http_response_code(404);echo json_encode(['error'=>'Task not found']);exit;} $st=$pdo->prepare('SELECT vip_level FROM users WHERE id=?');$st->execute([$uid]); $vip=intval(($st->fetch()['vip_level']??1)); $st=$pdo->prepare('SELECT min_award,max_award FROM lottery_awards WHERE product_id=? AND vip_level<=? ORDER BY vip_level DESC LIMIT 1');$st->execute([$task['pid'],$vip]); $aw=$st->fetch(); if(!$aw){http_response_code(500);echo json_encode(['error'=>'Award not configured']);exit;} $min=floatval($aw['min_award']); $max=floatval($aw['max_award']); $amount=mt_rand(intval($min*100),intval($max*100))/100.0; $pdo->prepare('UPDATE user_lottery_tasks SET status="completed",awarded_amount=?,completed_at=NOW() WHERE id=?')->execute([$amount,$tid]); $pdo->prepare('UPDATE users SET balance=balance+? WHERE id=?')->execute([$amount,$uid]); $pdo->prepare("INSERT INTO user_balance_transactions(user_id,amount,type,description) VALUES(?,?,'award',?)")->execute([$uid,$amount,'Lottery award for task #'.$tid]); echo json_encode(['success'=>true,'awarded'=>$amount]); ?>